name: CI

on:
  push:
    branches: [main]
    paths:
      - 'apk/**'
      - 'scripts/**'
      - 'build/**'
      - '.github/workflows/**'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # ============================================================================
  # LINT & VALIDATE
  # ============================================================================
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Lint shell scripts
        run: |
          echo "üîç Linting shell scripts..."
          # SC2039: POSIX sh doesn't support some features (we use compatible alternatives)
          # SC3037: echo -n is not POSIX (we use printf instead where needed)
          shellcheck -s sh -e SC2039,SC3037 \
            apk/CONTROL/*.sh scripts/*.sh 2>&1 || {
            echo "‚ö†Ô∏è ShellCheck found issues (non-blocking)"
          }
          echo "‚úÖ Shell script lint complete"

      - name: Check line endings
        run: |
          echo "üîç Checking line endings..."
          ERRORS=0
          for script in apk/CONTROL/*.sh scripts/*.sh; do
            if file "$script" | grep -q "CRLF"; then
              echo "‚ùå CRLF: $script"
              ERRORS=$((ERRORS + 1))
            fi
          done
          [ $ERRORS -eq 0 ] || exit 1
          echo "‚úÖ All scripts have Unix line endings"

      - name: Validate JSON files
        run: |
          echo "üîç Validating JSON files..."
          for json in apk/CONTROL/*.json; do
            jq . "$json" > /dev/null || { echo "‚ùå Invalid: $json"; exit 1; }
            echo "‚úÖ $json"
          done

      - name: Validate config.json structure
        run: |
          python3 << 'EOF'
          import json, re, sys

          config = json.load(open('apk/CONTROL/config.json'))
          g = config.get('general', {})

          errors = []

          # Package name validation
          if not re.match(r'^[a-z][a-z0-9]*(\.[a-z][a-z0-9]*)+$', g.get('package', '')):
              errors.append(f"Invalid package name: {g.get('package')}")

          # Architecture validation
          if g.get('architecture') not in ['x86-64', 'arm64', 'any']:
              errors.append(f"Invalid architecture: {g.get('architecture')}")

          # Version format validation
          version = g.get('version', '')
          if not re.match(r'^\d+\.\d+\.\d+(\.(r|dev)\d+)?$', version):
              errors.append(f"Invalid version format: {version}")

          # Required fields
          required = ['package', 'version', 'name', 'architecture']
          for field in required:
              if not g.get(field):
                  errors.append(f"Missing required field: general.{field}")

          # Register section validation (ASUSTOR specific)
          reg = config.get('register', {})
          if not reg:
              errors.append("Missing register section")

          if errors:
              print("‚ùå config.json validation failed:")
              for e in errors:
                  print(f"   - {e}")
              sys.exit(1)

          print(f"‚úÖ config.json valid")
          print(f"   Package: {g.get('package')}")
          print(f"   Version: {g.get('version')}")
          print(f"   Architecture: {g.get('architecture')}")
          EOF

      - name: Check required files
        run: |
          echo "üîç Checking required files..."
          required_files="
            apk/CONTROL/config.json
            apk/CONTROL/description.json
            apk/CONTROL/icon.png
            apk/CONTROL/common.sh
            apk/CONTROL/bootstrap-logging.sh
            apk/CONTROL/pre-install.sh
            apk/CONTROL/post-install.sh
            apk/CONTROL/start-stop.sh
            build/build.py
            build/version-manager.py
            README.md
            LICENSE
          "
          MISSING=0
          for f in $required_files; do
            if [ -f "$f" ]; then
              echo "‚úÖ $f"
            else
              echo "‚ùå Missing: $f"
              MISSING=$((MISSING + 1))
            fi
          done
          [ $MISSING -eq 0 ] || exit 1

      - name: Validate icon size
        run: |
          echo "üîç Checking icon size..."
          SIZE=$(identify -format "%wx%h" apk/CONTROL/icon.png 2>/dev/null || echo "unknown")
          if [ "$SIZE" = "90x90" ]; then
            echo "‚úÖ Icon size: 90x90"
          else
            echo "‚ùå Icon should be 90x90, got: $SIZE"
            exit 1
          fi

  # ============================================================================
  # TEST
  # ============================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install test dependencies
        run: |
          pip install pytest

      - name: Run shell tests
        run: |
          echo "üß™ Running shell tests..."
          sh scripts/test.sh

      - name: Run Python tests
        run: |
          echo "üß™ Running Python tests..."
          python3 -m pytest build/tests/ -v --tb=short || {
            echo "‚ö†Ô∏è Some Python tests failed (see above)"
          }

      - name: Verify Python syntax
        run: |
          echo "üîç Verifying Python syntax..."
          for py in build/*.py; do
            python3 -m py_compile "$py" && echo "‚úÖ $py"
          done

  # ============================================================================
  # BUILD (uses reusable workflow)
  # ============================================================================
  build:
    name: Build
    needs: [lint, test]
    uses: ./.github/workflows/build.yml

  # ============================================================================
  # SUMMARY
  # ============================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## üì¶ CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
